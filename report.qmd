
---
title: "Spatio‑Temporal Patterns of African Hominins"
author: "Hominid Dates Project"
date: "`r format(Sys.Date(), '%d %b %Y')`"
format:
  pdf:
    toc: true
    number-sections: false
    geometry:
      - left=0.6in
      - right=0.6in
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
import::from("targets", tar_read)
import::from("dplyr", mutate, arrange)
import::from("kableExtra", kable_styling, kable_classic)
```

## Overview

This report provides a brief summary of specimen counts and temporal relationships in the **Hominid Dates** database.  
Full reproducible workflow available in the project GitHub repository (https://github.com/BWBrook/hominid-dates).  
Here we focus on headline patterns and intuitive graphics.  

---

## 1 Specimen totals

### 1.1 Genus counts

```{r genus-tbl}
genus_tbl <- tar_read(genus_species_freq)$genus_freq
knitr::kable(genus_tbl,
             caption = "Specimen counts per genus (collapsed by duplicate fragments).",
             digits = 3) |>
  kable_styling(full_width = FALSE) |>
  kable_classic()
```

```{r genus-plot, fig.cap="Specimen counts per genus"}
tar_read(genus_plot)
```

### 1.2 Species counts (top 15)

```{r species-tbl}
species_tbl <- tar_read(genus_species_freq)$species_freq
knitr::kable(species_tbl,
             caption = "Specimen counts per species (all taxa).",
             digits = 3) |>
  kable_styling(full_width = FALSE) |>
  kable_classic()
```

```{r species-plot, fig.cap="Top 15 species by specimen count"}
tar_read(species_plot)
```

---

## 2 Temporal ranges

`first_occ` marks the **oldest** directly or indirectly dated horizon for a species;  
`last_occ` marks the youngest. The line segments in Figure 3 visualise these bounds; points mark ends.

```{r spans-table}
span_tbl <- tar_read(temporal_span) |>
  arrange(desc(first_occ))
```

```{r spans-kable}
knitr::kable(span_tbl,
             caption = "First and last appearances by species (Ma).",
             digits = 3) |>
  kable_styling(latex_options = c("scale_down")) |>
  kable_classic()
```

```{r span-plot, fig.cap="Temporal ranges of each species"}
tar_read(span_plot)
```

### 2.1 Uncertainty via Monte Carlo

We propagate dating uncertainty by sampling each occurrence’s true date from its interval and recomputing species spans over B draws.
Summaries report medians and 90% CIs.

```{r spans-mc-table}
spans_mc_tbl <- tar_read(spans_mc)
knitr::kable(spans_mc_tbl,
             caption = "Species span medians with 90\\% credible intervals (Ma).",
             digits = 3) |>
  kable_styling(latex_options = c("scale_down")) |>
  kable_classic()
```

```{r span-mc-plot, fig.cap="Temporal spans with MC median and 90% CI"}
tar_read(span_mc_plot)
```

---

## 3 Pairwise temporal overlap

Values express the length of time (in Ma) two species’ known intervals overlap.  
*Interpretation tips*:

* An overlap of **≈ 0 Ma** suggests sequential replacement or sampling gaps.  
* Larger cells (yellow in the heat‑map) denote prolonged co‑occurrence.  
* The diagonal is set to **NA** so that off‑diagonal relationships stand out; a species trivially overlaps itself by its full span.

```{r overlap-heatmap, fig.cap="Pairwise temporal overlap (Ma)"}
tar_read(overlap_plot)
```

```{r overlap-heatmap-mc, fig.cap="Pairwise temporal overlap (median over MC draws)"}
tar_read(overlap_mc_plot)
```

---

## 4 Species richness through time (MC)

```{r bin-counts-mc-table}
bin_counts_tbl <- tar_read(bin_counts_mc)
knitr::kable(bin_counts_tbl,
             caption = "Species richness per 0.1 Ma bin: median and 90\\% CI.",
             digits = 3) |>
  kable_styling(latex_options = c("scale_down")) |>
  kable_classic()
```

```{r bin-counts-mc-plot, fig.cap="Species richness over time (median with 90% CI)"}
tar_read(bin_counts_plot)
```

---

## 5 Site clusters (HDBSCAN)

Occurrences are clustered jointly in space–time using HDBSCAN on scaled `(lon, lat, date)` coordinates. Each observation receives a `cluster_id` (or `NA` if treated as noise). For each cluster, the within‑cluster temporal span serves as a simple "mixing index".

```{r st-mix-tbl}
st_mix <- tar_read(mixing_index_by_cluster)
knitr::kable(st_mix,
             caption = "Within‑cluster mixing index (temporal span in Ma).",
             digits = 3) |>
  kable_styling(full_width = FALSE) |>
  kable_classic()
```

```{r st-mix-plot, fig.cap="Within‑cluster temporal mixing index by cluster"}
tar_read(mixing_index_plot)
```

Exported artefacts: per‑observation clusters (`st_clusters.csv`) and cluster‑level mixing indices (`mixing_index_by_cluster.csv`).

---

## 6 Lead–Lag in FAD/LAD by Country

We compare each country’s first and last appearances (FAD/LAD) to the corresponding continent-level values for the same species. Values are computed over 1000 bootstrap draws from each occurrence’s date interval; we report medians and 95% CIs.

```{r leadlag-tbl}
leadlag_tbl <- tar_read(leadlag_country)
knitr::kable(leadlag_tbl,
             caption = "Delta FAD/Delta LAD by country relative to continent (medians with 95\\% CI).",
             digits = 3) |>
  kable_styling(latex_options = c("scale_down")) |>
  kable_classic()
```

```{r leadlag-ranks}
leadlag_ranks <- tar_read(leadlag_ranks)
knitr::kable(leadlag_ranks,
             caption = "Country rankings by Delta FAD and Delta LAD (ascending; ties share ranks).",
             digits = 3) |>
  kable_styling(latex_options = c("scale_down")) |>
  kable_classic()
```

```{r leadlag-maps, fig.cap="Lead–lag choropleths (Delta FAD) for selected species"}
map_paths <- tar_read(leadlag_maps)$path
to_show <- head(map_paths, 3)
knitr::include_graphics(to_show)
```

---

## 7 Sampling intensity caveat

The pipeline collapses fragments to uniques but records a `sampling_intensity` count.  
Where sampling is sparse (low counts or long hiatuses), absences may reflect fossilisation and recovery bias rather than true local extirpation.  
Upcoming occupancy models will incorporate this intensity as a detection covariate.

---

## 8 Re-occupancy gaps (Poisson)

We model detection at each site as an inhomogeneous Poisson process with a rate that tracks local sampling intensity through time. For each observed hiatus between finds at a site, we compute the probability of seeing no finds under the model and flag unexpectedly long gaps after FDR correction.

```{r reocc-top}
reocc_tbl  <- tar_read(reocc_pvals)
likely_tbl <- tar_read(likely_reoccupancy_events)
```

```{r reocc-plot, fig.cap="Gap-wise P(no finds) vs. hiatus duration; highlighted points pass FDR < 0.05"}
tar_read(reocc_pvals_plot)
```

```{r reocc-likely}
if (nrow(likely_tbl) > 0) {
  knitr::kable(likely_tbl,
               caption = "Likely re-occupancy events (FDR < 0.05), ordered by adjusted p-value.",
               digits = 3) |>
    kable_styling(full_width = FALSE) |>
    kable_classic()
} else {
  cat("No gaps pass FDR < 0.05 under the current specification.")
}
```

Exported artefacts (see outputs/): site-level lambda per bin (`site_lambda.csv`), full gap table (`reocc_pvals.csv`), and flagged events (`likely_reoccupancy_events.csv`).

---

## 9 Next steps

1. Implement Solow’s **OLE** to estimate continental extinction probabilities.  
2. Fit hierarchical occupancy models at key sites (e.g., Olduvai Gorge) integrating `sampling_intensity`.  
3. Visualise spatio‑temporal colonisation fronts via animated maps.
